<!DOCTYPE html>
<html>
<head>
<!-- "c:\Program Files\Google\Chrome\Application\chrome.exe" --allow-file-access-from-files file:///D:/Git/ribbon/tools/webui/summary.html -->
<!-- TODO: move to better way to build as SPA -->
<style>
ul {
	list-style-type: none;
	padding-inline-start: 0;
}
li {
  display: inline-block;
  padding: 0;
  border: 0;
  margin: 0;
}

.topic-list {
	display: flex;
	flex-direction: row;
	flex-wrap: nowrap;
}

.topic-list li {
}

ul.topic-word-list {
	display: flex;
	flex-direction: column;
	flex-wrap: nowrap;
	border-right: 1px solid black;
}
ul.topic-word-list li.topic-title {
	display: inline-block;
	font-size: 10px;
	font-weight: 800;
}

word-prob {
	display: inline-block;
	margin-left: 1ch;
	min-width: 20ch;
	font-size: 12px;
}

ul.phrase-list-list {
	display: flex;
	flex-direction: row;
	flex-wrap: nowrap;
}

ul.phrase-list {
	display: flex;
	flex-direction: column;
	flex-wrap: nowrap;
	border-right: 1px solid black;
}
phrase-item {
	display: inline-block;
	margin-left: 1ch;
	min-width: 20ch;
	font-size: 12px;
}
phrase-item .invalid {
	color: red;
}

</style>
<script type='text/javascript' src='https://ajax.aspnetcdn.com/ajax/knockout/knockout-3.5.0.js'></script>
<script>
(() => {

function DataModel()
{
	var me = this;

	// const
	me.mixUnigramSummaryJson = "mixunigram-summary.json";
	me.topicModelSummaryJson = "topicmodel-summary.json";
	me.phraseListSummaryJson = "phrase-list-summary.json";
	me.summaryTypeTopicModel = "topicModel";
	me.summaryTypePhraseList = "phraseList";

	// model
	me.dataModel = ko.observable(null);
	me.summaryType = ko.observable("");
	me.generatedTime = ko.observable("");
	// topic model data
	me.tps = {
		perplexity: ko.observable("0"),
		latestPerplexity: ko.observable("0"),
		topicEntropy: ko.observable("0"),
		entropyAverage: ko.observable("0"),
	};
	me.topicModel = ko.observableArray([]);
	// phrase list data
	me.pl = {
		phraseList: ko.observableArray([]),
		katakanaPhrase: ko.observableArray([]),
		unknownPhrase: ko.observableArray([]),
		unknownWords: ko.observableArray([]),
		unknownKatakana: ko.observableArray([]),
		unknownHiragana: ko.observableArray([]),
		unknownKanji: ko.observableArray([]),
		unknownOthers: ko.observableArray([]),
		numbers: ko.observableArray([]),
		emojis: ko.observableArray([])
	};

	me.reloadJson = (jsonUrl) => {
		me.downloadJson(jsonUrl).then(dataModel => {
			me.summaryType(dataModel.summaryType);
			if (dataModel.summaryType === me.summaryTypeTopicModel)
			{
				me.dataModel(dataModel);
				me.generatedTime(dataModel.generatedTime);
				me.tps.perplexity(dataModel.tps.perplexity.toString());
				me.tps.latestPerplexity(dataModel.tps.latestPerplexity.toString());
				me.tps.topicEntropy(dataModel.tps.topicEntropy.toString());
				me.tps.entropyAverage(dataModel.tps.entropyAverage.toString());
				me.topicModel(dataModel.topicModel);
			}
			else
			{
				me.dataModel(dataModel);
				me.generatedTime(dataModel.generatedTime);
				me.pl.phraseList(dataModel.phraseList);
				me.pl.katakanaPhrase(dataModel.katakanaPhrase);
				me.pl.unknownPhrase(dataModel.unknownPhrase);
				me.pl.unknownWords(dataModel.unknownWords);
				me.pl.unknownKatakana(dataModel.unknownKatakana);
				me.pl.unknownHiragana(dataModel.unknownHiragana);
				me.pl.unknownKanji(dataModel.unknownKanji);
				me.pl.unknownOthers(dataModel.unknownOthers);
				me.pl.numbers(dataModel.numbers);
				me.pl.emojis(dataModel.emojis);

			}
		});
	};

	me.downloadJson = function (url) {
		return new Promise((resolve, reject) => {
			var xmlHttp = new XMLHttpRequest();
			xmlHttp.onload = function() {
				var jsonResult = JSON.parse(xmlHttp.responseText);
				if (typeof jsonResult.error !== "undefined") {
					var errorCode = (typeof jsonResult.code !== "undefined") ? (jsonResult.code.toString() + ": ") : "";
					var errorText = errorCode + jsonResult.error;
					reject(errorText);
				} else {
					resolve(JSON.parse(xmlHttp.responseText));
				}
			}
			xmlHttp.onerror = function() {
				reject(xmlHttp.statusText);
			}
			xmlHttp.open("GET", url, true);
			// xmlHttp.responseType = "arraybuffer";
			xmlHttp.send();
		});
	};
}

ko.components.register("root-node", {
	template:
		'<h1>Summary Page <span data-bind="text: generatedTime"></span></h1>' + 
		'<button data-bind="click: onLoadTopicModel">TopicModel</button>' +
		'<button data-bind="click: onLoadMixUnigram">MixUnigram</button>' +
		'<button data-bind="click: onLoadPhraseList">PhraseList</button>' +
		'<!-- ko if: isTopicModel --><topic-model-summary params="dataModel:dataModel"></topic-model-summary><!-- /ko -->' +
		'<!-- ko if: isPhraseList --><phrase-list-summary params="dataModel:dataModel"></phrase-list-summary><!-- /ko -->'
	,
	viewModel: function (params) {
		var me = this;
		me.dataModel = new DataModel();
		me.generatedTime = me.dataModel.generatedTime;

		me.isTopicModel = ko.pureComputed(() => (me.dataModel.summaryType() === me.dataModel.summaryTypeTopicModel));
		me.isPhraseList = ko.pureComputed(() => (me.dataModel.summaryType() === me.dataModel.summaryTypePhraseList));

		me.onLoadTopicModel = function () { me.dataModel.reloadJson(me.dataModel.topicModelSummaryJson); };
		me.onLoadMixUnigram = function () { me.dataModel.reloadJson(me.dataModel.mixUnigramSummaryJson); };
		me.onLoadPhraseList = function () { me.dataModel.reloadJson(me.dataModel.phraseListSummaryJson); };

		me.dataModel.reloadJson(me.dataModel.topicModelSummaryJson);
	}
});

ko.components.register("topic-model-summary", {
	template:
		'<div class="topic-model-summary">' +
			'Latest Perplexity: <span data-bind="text: latestPerplexity"></span>, ' +
			'Perplexity: <span data-bind="text: perplexity"></span>, ' +
			'Topic Entropy: <span data-bind="text: topicEntropy"></span>, ' +
			'Entropy Average: <span data-bind="text: entropyAverage"></span>' +
			'<ul class="topic-list" data-bind="foreach: topicModel">' +
				'<li><topic-word-list params="wordList:$data, index:$index"></topic-word-list></li>' +
			'</ul>' +
		'</div>'
	,
	viewModel: function (params) {
		var me = this;
		me.topicModel = params.dataModel.topicModel;
		me.perplexity = params.dataModel.tps.perplexity;
		me.latestPerplexity = params.dataModel.tps.latestPerplexity;
		me.topicEntropy = params.dataModel.tps.topicEntropy;
		me.entropyAverage = params.dataModel.tps.entropyAverage;
	}
});

ko.components.register("topic-word-list", {
	template:
		'<ul class="topic-word-list">' +
			'<li class="topic-title"><span data-bind="text: title"></span></li>' +
			'<!-- ko foreach: wordList -->' +
				'<li><word-prob params="wp:$data"></word-prob></li>' +
			'<!-- /ko -->' +
		'</ul>'
	,
	viewModel: function (params) {
		var me = this;
		me.wordList = params.wordList;
		me.title = (params.index() == 0) ? "Low Entropy" :
					(params.index() == 1) ? "Low P * Entropy" :
					(params.index() == 2) ? "High Entropy" :
					(params.index() == 3) ? "High P * Entropy" :
					("Topic " + (params.index() - 3).toString());
	}
});

ko.components.register("word-prob", {
	template: '<span data-bind="text: wordText"></span>',
	viewModel: function (params) {
		var me = this;
		var wordProps = params.wp.w.split(",");
		me.wordText = wordProps[0] + "/" + wordProps[1];
	}
});

ko.components.register("phrase-list-summary", {
	template:
		'<ul class="phrase-list-list">' +
			'<li class="phrase-list-container">' +
				'<ul class="phrase-list">' +
					'<li class="phrase-list-title"><span>Phrases</span></li>' +
					'<!-- ko foreach: phraseList -->' +
						'<li><phrase-item params="ph:$data"></phrase-item></li>' +
					'<!-- /ko -->' +
				'</ul>' +
			'</li>' +
			'<li class="phrase-list-container">' +
				'<ul class="phrase-list">' +
					'<li class="phrase-list-title"><span>Katakana phrases</span></li>' +
					'<!-- ko foreach: katakanaPhrase -->' +
						'<li><phrase-item params="ph:$data"></phrase-item></li>' +
					'<!-- /ko -->' +
				'</ul>' +
			'</li>' +
			'<li class="phrase-list-container">' +
				'<ul class="phrase-list">' +
					'<li class="phrase-list-title"><span>Unknown phrases</span></li>' +
					'<!-- ko foreach: unknownPhrase -->' +
						'<li><phrase-item params="ph:$data"></phrase-item></li>' +
					'<!-- /ko -->' +
				'</ul>' +
			'</li>' +
			'<li class="phrase-list-container">' +
				'<ul class="phrase-list">' +
					'<li class="phrase-list-title"><span>Unknown words</span></li>' +
					'<!-- ko foreach: unknownWords -->' +
						'<li><phrase-item params="ph:$data"></phrase-item></li>' +
					'<!-- /ko -->' +
				'</ul>' +
			'</li>' +
			'<li class="phrase-list-container">' +
				'<ul class="phrase-list">' +
					'<li class="phrase-list-title"><span>Unknown Katakana</span></li>' +
					'<!-- ko foreach: unknownKatakana -->' +
						'<li><phrase-item params="ph:$data"></phrase-item></li>' +
					'<!-- /ko -->' +
				'</ul>' +
			'</li>' +
			'<li class="phrase-list-container">' +
				'<ul class="phrase-list">' +
					'<li class="phrase-list-title"><span>Unknown Hiragana</span></li>' +
					'<!-- ko foreach: unknownHiragana -->' +
						'<li><phrase-item params="ph:$data"></phrase-item></li>' +
					'<!-- /ko -->' +
				'</ul>' +
			'</li>' +
			'<li class="phrase-list-container">' +
				'<ul class="phrase-list">' +
					'<li class="phrase-list-title"><span>Unknown Kanji</span></li>' +
					'<!-- ko foreach: unknownKanji -->' +
						'<li><phrase-item params="ph:$data"></phrase-item></li>' +
					'<!-- /ko -->' +
				'</ul>' +
			'</li>' +
			'<li class="phrase-list-container">' +
				'<ul class="phrase-list">' +
					'<li class="phrase-list-title"><span>Unknown Others</span></li>' +
					'<!-- ko foreach: unknownOthers -->' +
						'<li><phrase-item params="ph:$data"></phrase-item></li>' +
					'<!-- /ko -->' +
				'</ul>' +
			'</li>' +
			'<li class="phrase-list-container">' +
				'<ul class="phrase-list">' +
					'<li class="phrase-list-title"><span>Numbers</span></li>' +
					'<!-- ko foreach: numbers -->' +
						'<li><phrase-item params="ph:$data"></phrase-item></li>' +
					'<!-- /ko -->' +
				'</ul>' +
			'</li>' +
			'<li class="phrase-list-container">' +
				'<ul class="phrase-list">' +
					'<li class="phrase-list-title"><span>Emojis</span></li>' +
					'<!-- ko foreach: emojis -->' +
						'<li><phrase-item params="ph:$data"></phrase-item></li>' +
					'<!-- /ko -->' +
				'</ul>' +
			'</li>' +
		'</ul>'
	,
	viewModel: function (params) {
		var me = this;
		me.phraseList = params.dataModel.pl.phraseList;
		me.katakanaPhrase = params.dataModel.pl.katakanaPhrase;
		me.unknownPhrase = params.dataModel.pl.unknownPhrase;
		me.unknownWords = params.dataModel.pl.unknownWords;
		me.unknownKatakana = params.dataModel.pl.unknownKatakana;
		me.unknownHiragana = params.dataModel.pl.unknownHiragana;
		me.unknownKanji = params.dataModel.pl.unknownKanji;
		me.unknownOthers = params.dataModel.pl.unknownOthers;
		me.numbers = params.dataModel.pl.numbers;
		me.emojis = params.dataModel.pl.emojis;
	}
});

ko.components.register("phrase-item", {
	template:
		'<!-- ko foreach: words --><span data-bind="css: { invalid: isInvalid }, attr: { title: pos }, text:text"></span>/<!-- /ko --> (<span data-bind="text: count"></span>)'
		,
		viewModel: function (params) {
		var me = this;
		var reIsValid = new RegExp("\\*,\\*$|,フィラー,");
		me.words = params.ph.w.map(x => {
			var isInValid = (reIsValid.exec(x) != null);
			return {
				pos: x,
				isInvalid: isInValid,
				text: x.split(",")[0] + (isInValid ? "*" : "")
			};
		});
		me.count = params.ph.c;
	}
});

window.onload = function () { ko.applyBindings(); }
})();
</script>

</head>
<body>
<root-node></root-node>
</body>
</html>
